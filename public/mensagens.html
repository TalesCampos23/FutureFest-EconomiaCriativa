<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mensagens ‚Äî ConectaIA Suprema</title>

  <link href="https://fonts.googleapis.com/css2?family=montserrat:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- tensorflow.js e universal sentence encoder (para embeddings no browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>

  <!-- chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:'montserrat',system-ui;background:#f7fbfd;color:#0e2b3b; padding-left:78px; /* espa√ßo para sidebar */ }
    .navbar{position:fixed;top:0;left:78px;right:0;height:72px;background:#164457;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:60;border-bottom:1px solid rgba(0,0,0,0.04)}
    .wrap{max-width:1200px;margin:110px auto 40px;padding:24px;display:flex;gap:18px}
    .convs{width:320px;background:#ffffff;padding:12px;border-radius:12px;box-shadow:0 8px 18px rgba(6,50,63,0.06);height:560px;overflow:auto;flex-shrink:0}
    .chat{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.95), #ffffff);padding:18px;border-radius:12px;box-shadow:0 8px 18px rgba(6,50,63,0.06);display:flex;flex-direction:column;height:560px;position:relative;backdrop-filter: blur(4px)}
    .conv{padding:12px;border-radius:10px;cursor:pointer;border-left:4px solid transparent}
    .conv.active{border-left-color:#3fd6ff;background:#f0fbff}
    .conv-title{font-weight:700;color:#06323f}
    .conv-sub{font-size:13px;color:#6b8b95;margin-top:6px}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:14px}
    .msg{padding:12px;border-radius:14px;max-width:84%;line-height:1.5;display:inline-block;word-wrap:break-word;box-shadow:0 4px 10px rgba(6,50,63,0.04)}
    .msg.in{background:linear-gradient(180deg,#e9fbff,#e3f7ff);align-self:flex-start;position:relative;padding-left:64px}
    .msg.out{background:linear-gradient(180deg,#eafef4,#dff6e1);align-self:flex-end}
    .avatar{width:44px;height:44px;border-radius:50%;background:#3fd6ff;border:3px solid #06323f;position:absolute;left:-54px;top:8px;display:flex;align-items:center;justify-content:center;color:#06323f;font-weight:800;font-size:12px;box-shadow:0 4px 10px rgba(6,50,63,0.08)}
    .typing{display:flex;align-items:center;gap:10px;font-size:13px;color:#6b8b95;padding:10px 14px;border-radius:12px;background:#fff6eb;border:1px solid #f0e7d6;width:max-content}
    .dots{display:inline-block;width:40px}
    .dot{display:inline-block;width:7px;height:7px;margin:0 3px;border-radius:50%;background:#c8dfe9;opacity:0;animation:dots 1.05s infinite}
    .dot:nth-child(1){animation-delay:0s}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes dots{0%{opacity:0;transform:translateY(0)}50%{opacity:1;transform:translateY(-5px)}100%{opacity:0;transform:translateY(0)}}
    .composer{display:flex;gap:8px;padding-top:12px;align-items:center}
    .composer input{flex:1;padding:12px;border-radius:12px;border:1px solid #e6eef2;background:white}
    .btn{padding:10px 14px;border-radius:12px;border:none;background:#3fd6ff;color:#06323f;cursor:pointer;font-weight:700}
    .controls{display:flex;gap:8px;margin-left:8px}
    .campaign-card{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:1px solid #e6eef2;background:rgba(255,255,255,0.9);max-width:640px}
    .campaign-card img{width:100px;height:72px;object-fit:cover;border-radius:8px}
    .campaign-card .meta{font-size:15px;color:#06323f;font-weight:700}
    .campaign-card .desc{font-size:13px;color:#6b8b95}
    .chart-wrap{padding:12px;border-radius:10px;background:#fff;border:1px solid #e6eef2;max-width:640px}
    .ai-highlight{background:linear-gradient(90deg,#e6fbff,#e0f8ff);padding:10px;border-radius:8px;border-left:4px solid #3fd6ff;margin-top:8px}
    .small-muted{font-size:12px;color:#6b8b95;margin-top:6px}
    @media(max-width:900px){body{padding-left:0}.wrap{flex-direction:column;margin-top:80px}.convs{width:100%;height:200px}.chat{height:auto}}
    /* sidebar */
    .sidebar{width:78px;background:#fff;box-shadow:2px 0 8px rgba(0,0,0,0.06);display:flex;flex-direction:column;align-items:center;padding-top:22px;position:fixed;top:0;left:0;bottom:0;z-index:70}
    .sidebar a{display:flex;flex-direction:column;align-items:center;gap:6px;text-decoration:none;color:#0e2b3b;margin-bottom:18px;font-size:11px;width:100%;justify-content:center;padding:8px 0}
    .sidebar img.icon{width:28px;height:28px}
    .muted{color:#6b8b95;font-size:13px}
    .title-lg{font-size:18px;font-weight:800;color:#06323f}
    /* small adjustments */
    .messages::-webkit-scrollbar, .convs::-webkit-scrollbar { height:8px; width:8px }
    .messages::-webkit-scrollbar-thumb, .convs::-webkit-scrollbar-thumb { background:rgba(6,50,63,0.08); border-radius:8px }
  </style>
</head>

<body>
  <!-- sidebar -->
  <nav class="sidebar" aria-label="menu principal">
    <a href="pagina-inicial.html" title="In√≠cio"><img class="icon" src="https://img.icons8.com/ios-filled/50/000000/home.png"><span>In√≠cio</span></a>
    <a href="explorar.html" title="Explorar"><img class="icon" src="https://img.icons8.com/ios-filled/50/000000/compass--v1.png"><span>Explorar</span></a>
    <a href="atualizacoes.html" title="Atualiza√ß√µes"><img class="icon" src="https://img.icons8.com/ios-filled/50/000000/activity-history.png"><span>Atualiza√ß√µes</span></a>
    <a href="mensagens.html" class="active" title="Mensagens"><img class="icon" src="https://img.icons8.com/ios-filled/50/000000/new-message.png"><span>Mensagens</span></a>
    <a href="configuracoes.html" title="Configura√ß√µes"><img class="icon" src="https://img.icons8.com/ios-filled/50/000000/settings.png"><span>Configura√ß√µes</span></a>
  </nav>

  <!-- navbar -->
  <nav class="navbar">
    <div style="display:flex;gap:12px;align-items:center">
      <img src="images/logo.png" style="width:38px;height:38px;object-fit:contain">
      <strong>ConectaDoa</strong>
    </div>
    <div style="font-size:14px;color:#bde6f5">ConectaIA ‚Äî Assistente Suprema</div>
  </nav>

  <div class="wrap" role="main">
    <aside class="convs" id="listaConvs" aria-label="conversas"></aside>

    <section class="chat" aria-label="chat principal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div>
          <div class="title-lg"><img src='images/Floating Robot.jpg' width="40px" style="vertical-align:middle;margin-right:6px;">ConectaIA ‚Äî Assistente Suprema</div>
          <div class="small-muted">Pe√ßa recomenda√ß√µes por estado (ex.: "ONGs em SP para alimentos") ou pe√ßa impacto por estado (ex.: "impacto do Cear√°").</div>
        </div>
      </div>

      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="composer" id="composer" role="form" aria-label="composer">
        <input id="msgInput" placeholder="Ex.: Ol√° / Recomende ONGs em SP que aceitam roupas / Mostre impacto de MG" aria-label="mensagem" />
        <div class="controls">
          <button id="sendBtn" class="btn">Enviar</button>
          <button id="limparBtn" class="btn" style="background:#ffb3b3;color:#3b0b0b">Limpar conversa</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* ConectaIA Suprema ‚Äî vers√£o final client-side (op√ß√£o B: vidro equilibrado)
       - corrige extra√ß√£o de estado (evita 'para' => PA)
       - prioriza siglas (SP, RJ)
       - gr√°ficos √∫nicos por estado
       - usa USE local quando dispon√≠vel (ranking), e OpenAI para polir textos
    */

    // ---------- dados: amostra cobrindo v√°rios estados
    function carregarCampanhas(){
      const raw = localStorage.getItem('campanhas')
      if(raw) try { return JSON.parse(raw) } catch(e){ console.warn('campanhas parse falhou') }
      return [
        {id:1,titulo:'Escola Comunidade Viva',desc:'Refor√ßo escolar + distribui√ß√£o de cestas',tags:['alimentos','educa√ß√£o'],regiao:'SP',img:'https://images.pexels.com/photos/5905494/pexels-photo-5905494.jpeg'},
        {id:2,titulo:'Banco de Alimentos Paulista',desc:'Triagem e distribui√ß√£o de alimentos',tags:['alimentos','solidariedade'],regiao:'SP',img:'https://images.pexels.com/photos/6646908/pexels-photo-6646908.jpeg'},
        {id:3,titulo:'Sa√∫de Solid√°ria RJ',desc:'Cl√≠nica comunit√°ria e doa√ß√µes de rem√©dios',tags:['sa√∫de'],regiao:'RJ',img:'https://images.pexels.com/photos/3992933/pexels-photo-3992933.jpeg'},
        {id:4,titulo:'M√£es Que Educam',desc:'Apoio a m√£es e crian√ßas',tags:['apoio','voluntariado'],regiao:'RJ',img:'https://images.pexels.com/photos/2647937/pexels-photo-2647937.jpeg'},
        {id:5,titulo:'Cidade Verde BH',desc:'Coleta seletiva e oficinas',tags:['meio ambiente'],regiao:'MG',img:'https://images.pexels.com/photos/3735214/pexels-photo-3735214.jpeg'},
        {id:6,titulo:'Biblioteca Aberta Salvador',desc:'Doa√ß√£o de livros e leitura',tags:['educa√ß√£o','cultura'],regiao:'BA',img:'https://images.pexels.com/photos/1370298/pexels-photo-1370298.jpeg'},
        {id:7,titulo:'Horta Comunit√°ria Curitiba',desc:'Capacita√ß√£o em agricultura urbana',tags:['sustentabilidade'],regiao:'PR',img:'https://images.pexels.com/photos/4503262/pexels-photo-4503262.jpeg'},
        {id:8,titulo:'Acolher RS',desc:'Apoio psicossocial e psicologia',tags:['sa√∫de','bem-estar'],regiao:'RS',img:'https://images.pexels.com/photos/5699456/pexels-photo-5699456.jpeg'},
        {id:9,titulo:'Oficina Profissional Recife',desc:'Cursos t√©cnicos e gera√ß√£o de renda',tags:['trabalho','educa√ß√£o'],regiao:'PE',img:'https://images.pexels.com/photos/3184306/pexels-photo-3184306.jpeg'},
        {id:10,titulo:'SOS Amaz√¥nia',desc:'Projetos de conserva√ß√£o e apoio √†s comunidades',tags:['meio ambiente','apoio'],regiao:'AM',img:'https://images.pexels.com/photos/691668/pexels-photo-691668.jpeg'}
      ]
    }

    const campanhas = carregarCampanhas()

    // ---------- conversa inicial
    let convs = JSON.parse(localStorage.getItem('conversas') || '[]')
    if(!convs.length){
      convs = [{id:1,name:'ConectaIA Suprema',ai:true,messages:[
        {from:'in',text:'Ol√°! ü§ñ Eu sou a ConectaIA Suprema ‚Äî sua assistente do ConectaDoa. Posso recomendar ONGs por estado, mostrar relat√≥rios de impacto por estado e ajudar a planejar doa√ß√µes (alimentos, roupas, dinheiro, voluntariado). Pergunte: "Recomende ONGs em SP para alimentos" ou "Mostre impacto do Cear√°".'}
      ]}]
      localStorage.setItem('conversas', JSON.stringify(convs))
    }

    // ---------- elementos
    let activeId = 1
    const listaConvs = document.getElementById('listaConvs')
    const messages = document.getElementById('messages')
    const msgInput = document.getElementById('msgInput')
    const sendBtn = document.getElementById('sendBtn')
    const limparBtn = document.getElementById('limparBtn')

    function renderConvs(){
      listaConvs.innerHTML = ''
      convs.forEach(c=>{
        const el = document.createElement('div'); el.className='conv'+(c.id===activeId?' active':'')
        el.dataset.id=c.id
        el.innerHTML = `<div class="conv-title">${escapeHtml(c.name)}</div><div class="conv-sub">Assistente Suprema</div>`
        el.onclick = ()=> openChat(c.id)
        listaConvs.appendChild(el)
      })
    }

    function openChat(id){
      activeId = id
      const conv = convs.find(c=>c.id===id)
      renderMessages(conv)
    }

    // ---------- text -> html (markdown-lite)
    function aiTextToHtml(text){
      if(!text) return ''
      text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n')
      const lines = text.split('\n')
      let html='', inList=false
      for(const raw of lines){
        const line = raw.trim()
        if(line===''){ if(inList){ html+='</ul>'; inList=false } continue }
        if(/^#{1,4}\s+/.test(line)){ if(inList){ html+='</ul>'; inList=false } const lvl=Math.min(4,(line.match(/^#+/)[0].length)+1); const content=line.replace(/^#+\s+/,''); html+=`<h${lvl} style="margin:8px 0;color:#06323f">${escapeHtml(content)}</h${lvl}>`; continue }
        if(/^(-|\u2022|\*)\s+/.test(line)){ if(!inList){ html+='<ul style="margin:6px 0 10px 18px;color:#06323f">'; inList=true } const item=line.replace(/^(-|\u2022|\*)\s+/,''); html+='<li style="margin:6px 0;color:#0e2b3b">'+escapeHtml(item)+'</li>'; continue }
        let replaced = escapeHtml(line).replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`(.+?)`/g,'<code style="background:#f1f7fb;padding:2px 6px;border-radius:6px">$1</code>')
        if(inList){ html+='</ul>'; inList=false }
        html+=`<p style="margin:6px 0">${replaced}</p>`
      }
      if(inList) html+='</ul>'
      return html
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]) }

    function renderMessages(conv){
      messages.innerHTML=''
      conv.messages.forEach(m=> renderMessage(m, conv))
      messages.scrollTop = messages.scrollHeight
    }

    function renderMessage(m, conv){
      const wrapper = document.createElement('div'); wrapper.className='msg '+(m.from==='out'?'out':'in')
      let showAvatar=false
      if(m.ai===true) showAvatar=true
      else if(conv && conv.ai && m.from==='in') showAvatar=true
      if(showAvatar){ const av=document.createElement('div'); av.className='avatar'; av.textContent='AI'; wrapper.appendChild(av) }

      if(m.type==='campaigns' && Array.isArray(m.campaigns)){
        const col=document.createElement('div'); col.style.display='flex'; col.style.flexDirection='column'; col.style.gap='8px'
        m.campaigns.forEach(cm=>{
          const card=document.createElement('div'); card.className='campaign-card'
          const img=document.createElement('img'); img.src=cm.img||''
          const info=document.createElement('div')
          info.innerHTML = `<div class="meta">${escapeHtml(cm.titulo)}</div><div class="desc">${escapeHtml(cm.desc)} ‚Ä¢ ${escapeHtml(cm.regiao)}</div><div style="margin-top:8px"><a href="campanha.html?campanha=${encodeURIComponent(cm.id)}" style="text-decoration:none;color:#06323f;font-weight:800">Ver campanha</a></div>`
          card.appendChild(img); card.appendChild(info); col.appendChild(card)
        })
        wrapper.appendChild(col)
      } else if(m.type==='chart' && m.chartData){
        const cont=document.createElement('div'); cont.className='chart-wrap'
        const title=document.createElement('div'); title.style.fontWeight=800; title.style.marginBottom='8px'; title.textContent=m.chartTitle||'Impacto'
        const canvas=document.createElement('canvas'); canvas.width=640; canvas.height=240
        cont.appendChild(title); cont.appendChild(canvas); wrapper.appendChild(cont)
        setTimeout(()=> drawChart(canvas, m.chartData), 80)
      } else {
        const content=document.createElement('div')
        if(m.from==='in') content.innerHTML = aiTextToHtml(m.text||'')
        else content.textContent = m.text||''
        wrapper.appendChild(content)
      }
      messages.appendChild(wrapper)
    }

    function drawChart(canvas, data){
      const ctx = canvas.getContext('2d')
      if(canvas._chart) canvas._chart.destroy()
      canvas._chart = new Chart(ctx, {
        type:'bar',
        data:{ labels: data.labels, datasets:[{ label: data.label||'impacto', data: data.values, backgroundColor: 'rgba(63,214,255,0.6)', borderColor:'rgba(6,50,63,0.9)', borderWidth:1 }]},
        options:{ responsive:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ display:false } } }
      })
    }

    function save(){ localStorage.setItem('conversas', JSON.stringify(convs)) }

    function showTyping(msg){
      removeTyping()
      const el=document.createElement('div'); el.className='typing'; el.id='typingIndicator'
      el.innerHTML = '<div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div><div>'+escapeHtml(msg||'ConectaIA est√° digitando...')+'</div>'
      const wrap=document.createElement('div'); wrap.className='msg in'; wrap.style.background='transparent'; wrap.appendChild(el)
      messages.appendChild(wrap); messages.scrollTop = messages.scrollHeight
    }
    function removeTyping(){ const t=document.getElementById('typingIndicator'); if(t && t.parentNode) t.parentNode.remove() }

    // ---------- OpenAI helper (polish) ----------
    function callOpenAI(prompt, system){
      return fetch('/api/openai', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ prompt, system })
      }).then(r=>{
        if(!r.ok) throw new Error('erro na api')
        return r.json()
      }).then(j=> j && j.text ? j.text : null).catch(e=>{
        console.warn('openai fallback:', e)
        return null
      })
    }

    // ---------- USE model (background) ----------
    use.load().then(m=>{ window.__use_model = m }).catch(e=>{ console.warn('USE load fail', e) })

    function recommendWithUSE(profileText, topN=4){
      return new Promise((resolve)=>{
        if(!window.__use_model){ resolve([]); return }
        const texts = campanhas.map(c=> (c.titulo||'') + ' ' + (c.desc||'') + ' ' + (c.tags||[]).join(' ') + ' ' + (c.regiao||'') )
        Promise.all([ window.__use_model.embed(texts).then(e=>e.array()), window.__use_model.embed([profileText]).then(e=>e.array()) ])
          .then(results=>{
            const campEmb = results[0], profEmb = results[1][0]
            function cosine(a,b){ let dot=0,na=0,nb=0; for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i] } return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-10) }
            const sims = campEmb.map((ce,idx)=>({idx,score:cosine(ce,profEmb)}))
            sims.sort((a,b)=> b.score - a.score)
            const chosen = sims.slice(0,topN).map(s=>{ const c=campanhas[s.idx]; c._score=s.score; return c })
            resolve(chosen)
          }).catch(e=>{ console.error('embeddings error',e); resolve([]) })
      })
    }

    // ---------- estados do Brasil (sigla -> nome)
    const BRAZIL_STATES = {
      'AC':'acre','AL':'alagoas','AP':'amap√°','AM':'amazonas','BA':'bahia','CE':'cear√°','DF':'distrito federal',
      'ES':'esp√≠rito santo','GO':'goi√°s','MA':'maranh√£o','MT':'mato grosso','MS':'mato grosso do sul','MG':'minas gerais',
      'PA':'par√°','PB':'para√≠ba','PR':'paran√°','PE':'pernambuco','PI':'piau√≠','RJ':'rio de janeiro','RN':'rio grande do norte',
      'RS':'rio grande do sul','RO':'rond√¥nia','RR':'roraima','SC':'santa catarina','SP':'s√£o paulo','SE':'sergipe','TO':'tocantins'
    }

    const STATE_SIGLAS = Object.keys(BRAZIL_STATES)
    const STATE_NAMES = STATE_SIGLAS.map(s => BRAZIL_STATES[s])

    // ---------- extract state robustly (prioriza sigla, evita "para" => PA)
    function extractState(text){
      if(!text) return null
      // 1) procurar siglas (palavras de 2 letras). Isso evita confundir preposi√ß√µes.
      const sigMatchAll = text.match(/\b([A-Za-z]{2})\b/g)
      if(sigMatchAll){
        for(const m of sigMatchAll){
          const cand = m.toUpperCase()
          if(BRAZIL_STATES[cand]) return cand
        }
      }
      // 2) procurar nomes completos (com boundary). checa formas sem/ com acento
      const t = text.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()
      for(const sig of STATE_SIGLAS){
        const name = BRAZIL_STATES[sig]
        const nameNorm = name.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()
        const re = new RegExp('\\b' + nameNorm.replace(/\s+/g,'\\s+') + '\\b','i')
        if(re.test(t)) return sig
      }
      return null
    }

    // ---------- detect donation type ----------
    function extractDonationType(text){
      if(!text) return null
      const t = text.toLowerCase()
      if(/alimen|comida|refei|alimentar|cesta/.test(t)) return 'alimentos'
      if(/roupa|vestu|agasalho/.test(t)) return 'roupas'
      if(/dinhe|pix|cartao|money|doa√ß|doacao|doa√ß√£o/.test(t)) return 'dinheiro'
      if(/volunt|voluntariado|ajudar pessoalmente|trabalhar como voluntario/.test(t)) return 'voluntariado'
      return null
    }

    // ---------- sample impact data per state (unique numbers) ----------
    const SAMPLE_IMPACT = {
      'SP':[3280,14,120],'RJ':[1120,5,45],'MG':[900,6,30],'BA':[620,3,22],'RS':[780,4,28],
      'PR':[540,3,18],'PE':[430,2,20],'CE':[710,4,25],'AM':[260,2,15],'PA':[300,2,18],
      'DF':[150,1,10],'ES':[210,1,12],'GO':[190,1,11],'MA':[130,1,9],'PI':[120,1,8],
      'RN':[110,1,7],'PB':[100,1,6],'SE':[80,1,5],'AL':[70,1,5],'RO':[95,1,6],
      'AC':[40,1,3],'RR':[20,0,2],'AP':[30,0,2],'MT':[200,2,10],'MS':[140,1,7],'TO':[85,1,6]
    }

    // ---------- business logic: filter campaigns ----------
    function filterCampaignsBy(stateSig, donationType){
      let list = campanhas.slice()
      if(stateSig){
        list = list.filter(c => (c.regiao||'').toUpperCase() === stateSig.toUpperCase())
      }
      if(donationType){
        const dt = donationType.toLowerCase()
        list = list.filter(c => (c.tags||[]).some(tag => (tag||'').toLowerCase().includes(dt)) || (c.desc||'').toLowerCase().includes(dt))
      }
      return list
    }

    // ---------- generate recommendations ----------
    async function gerarRecomendacoes(userText){
      removeTyping()
      const conv = convs.find(c=>c.id===activeId)
      const state = extractState(userText)
      const dtype = extractDonationType(userText)
      const stateLabel = state ? `${state} ‚Äî ${BRAZIL_STATES[state]}` : 'Brasil (todas regi√µes)'
      const profile = `pedido: estado=${stateLabel}, tipo=${dtype||'geral'}. Texto: "${userText||''}"`

      showTyping('Buscando campanhas relevantes...')
      const filtered = filterCampaignsBy(state, dtype)

      // se houver resultados e modelo USE dispon√≠vel, ordena
      if(window.__use_model && filtered.length){
        try{
          const ranked = await recommendWithUSE(profile, Math.min(6, filtered.length))
          removeTyping()
          if(!ranked.length){
            conv.messages.push({from:'in', text:`Encontrei ${filtered.length} campanha(s) para ${stateLabel}. Exibindo lista:`, ai:true})
            conv.messages.push({from:'in', type:'campaigns', campaigns: filtered.slice(0,6), ai:true})
            save(); renderMessages(conv)
            return
          }
          conv.messages.push({from:'in', text:`Recomenda√ß√µes (estado: ${stateLabel}) ‚Äî tipo: ${dtype||'qualquer'}:`, ai:true})
          conv.messages.push({from:'in', type:'campaigns', campaigns: ranked, ai:true})
          save(); renderMessages(conv)

          // polir explica√ß√£o via OpenAI quando poss√≠vel
          const prompt = `Explique brevemente por que as seguintes campanhas s√£o boas para o pedido (estado=${stateLabel}, tipo=${dtype||'geral'}). D√™ 3 a√ß√µes pr√°ticas e um par√°grafo "Por que isso importa":\n` + ranked.map(x=>`- ${x.titulo}: ${x.desc}`).join('\n')
          showTyping('Aprimorando explica√ß√µes com a IA...')
          const text = await callOpenAI(prompt, RICH_SYSTEM_PROMPT).catch(()=>null)
          removeTyping()
          if(text) conv.messages.push({from:'in', text:text, ai:true})
          else {
            const fallback = ranked.map(x=>`${x.titulo} ‚Äî recomendado por tags e regi√£o (${(x.tags||[]).join(', ')}).`).join('\n')
            conv.messages.push({from:'in', text:'Explica√ß√£o r√°pida:\n'+fallback, ai:true})
          }
          save(); renderMessages(conv)
          return
        }catch(e){
          console.warn('rank error', e)
          removeTyping()
        }
      }

      // fallback: sem ranking
      removeTyping()
      if(filtered.length){
        conv.messages.push({from:'in', text:`Encontrei ${filtered.length} campanha(s) para ${stateLabel}. Exibindo:` , ai:true})
        conv.messages.push({from:'in', type:'campaigns', campaigns: filtered.slice(0,6), ai:true})
        save(); renderMessages(conv)
        const prompt2 = `Explique por que essas campanhas s√£o apropriadas para: estado=${stateLabel}, tipo=${dtype||'geral'}.\n` + filtered.slice(0,6).map(x=>`- ${x.titulo}: ${x.desc}`).join('\n')
        showTyping('Aprimorando explica√ß√£o (se poss√≠vel)...')
        const text2 = await callOpenAI(prompt2, RICH_SYSTEM_PROMPT).catch(()=>null)
        removeTyping()
        if(text2) conv.messages.push({from:'in', text:text2, ai:true})
        else conv.messages.push({from:'in', text:'Sugest√£o pr√°tica: entre em contato com a ONG, confirme necessidades atuais, combine log√≠stica e envie doa√ß√µes embaladas e etiquetadas.' , ai:true})
        save(); renderMessages(conv)
        return
      }

      conv.messages.push({from:'in', text:`N√£o encontrei campanhas para ${stateLabel} com o tipo ${dtype||'qualquer'}. Quer que eu pesquise por estados vizinhos ou por tipo diferente?`, ai:true})
      save(); renderMessages(conv)
    }

    // ---------- generate impact per state (chart + text) ----------
    async function gerarImpacto(stateParam){
      removeTyping()
      const conv = convs.find(c=>c.id===activeId)
      const state = (stateParam || 'SP').toUpperCase()
      const data = SAMPLE_IMPACT[state] || [Math.floor(Math.random()*900)+100, Math.floor(Math.random()*10)+1, Math.floor(Math.random()*60)+5]
      const chartData = { labels:['Fam√≠lias','Toneladas de Alimento','Volunt√°rios'], values: data, label: `Impacto ‚Äî ${state}` }

      conv.messages.push({from:'in', text:`Gerando gr√°fico de impacto para ${state} ‚Äî ${BRAZIL_STATES[state] || 'regi√£o' }...`, ai:true})
      conv.messages.push({from:'in', type:'chart', chartData: chartData, chartTitle: `Impacto estimado ‚Äî ${state}`, ai:true})
      save(); renderMessages(conv)

      const prompt = `Gere um relat√≥rio curto (3-5 frases) interpretando estes n√∫meros para o estado ${state}: fam√≠lias: ${data[0]}, toneladas: ${data[1]}, volunt√°rios: ${data[2]}. Destaque impacto social, recomenda√ß√µes e pr√≥ximos passos.`
      showTyping('gerando relat√≥rio com a IA...')
      const text = await callOpenAI(prompt, RICH_SYSTEM_PROMPT).catch(()=>null)
      removeTyping()
      if(text) conv.messages.push({from:'in', text:text, ai:true})
      else conv.messages.push({from:'in', text:`Relat√≥rio (${state}): ${data[0]} fam√≠lias beneficiadas; ${data[1]}t distribu√≠das; ${data[2]} volunt√°rios. Recomenda-se fortalecer pontos de coleta e campanhas de comunica√ß√£o local.`, ai:true})
      save(); renderMessages(conv)
    }

    // ---------- richer system prompt ----------
    const RICH_SYSTEM_PROMPT = `Voc√™ √© ConectaIA Suprema, assistente do ConectaDoa.
Responda sempre com:
- resumo 1 linha,
- explica√ß√£o detalhada,
- a√ß√µes pr√°ticas (bullets),
- Por que isso importa.
Se houver estado no pedido, adapte (use sigla e nome). Seja emp√°tico e objetivo.`

    // ---------- main processor ----------
    function processWithIA(texto){
      removeTyping()
      const conv = convs.find(c=>c.id===activeId)
      const t = texto.toLowerCase()

      // greeting
      if(/\b(oi|ol√°|ola|bom dia|boa tarde|boa noite)\b/.test(t)){
        const reply = `Ol√°! ü§ñ Eu sou a Intelig√™ncia Artificial do ConectaDoa. Eu recomendo ONGs de todos os estados do Brasil e mostro relat√≥rios de impacto das doa√ß√µes. Como posso ajudar hoje?`
        conv.messages.push({from:'in', text:reply, ai:true}); save(); renderMessages(conv); return
      }

      // recommendations intent
      if(/\b(recomend|indica|sugest|indique|onde|ong|ongs)\b/.test(t)){
        const state = extractState(texto)
        const type = extractDonationType(texto)
        if(!state && !type){
          showTyping('Buscando recomenda√ß√µes nacionais...')
          const national = filterCampaignsBy(null, null)
          removeTyping()
          conv.messages.push({from:'in', text:`Voc√™ quer sugest√µes ‚Äî sem estado definido. Aqui v√£o algumas recomenda√ß√µes nacionais iniciais:`, ai:true})
          conv.messages.push({from:'in', type:'campaigns', campaigns: national.slice(0,6), ai:true})
          conv.messages.push({from:'in', text:`Dica: se quiser mais precis√£o, diga o estado (ex.: "ONGs em SP para alimentos") ou o tipo (ex.: "roupas").`, ai:true})
          save(); renderMessages(conv)
          return
        }
        gerarRecomendacoes(texto)
        return
      }

      // impact intent
      if(/\b(impact|impacto|relat|relat√≥rio|grafico|gr√°fico)\b/.test(t)){
        const state = extractState(texto) || 'SP'
        gerarImpacto(state)
        return
      }

      // else: forward to OpenAI to craft a long, rich answer (polish)
      showTyping('resumindo e respondendo com detalhes...')
      const userPrompt = `Usu√°rio pergunta: "${texto}". Forne√ßa:
1) Um resumo em 1 linha,
2) Explica√ß√£o detalhada (2-4 par√°grafos) com exemplos pr√°ticos,
3) 3 passos recomendados (bullet),
4) Por que isso importa.
Se a pergunta mencionar algum estado, adapte ao estado. Seja claro e emp√°tico.`
      callOpenAI(userPrompt, RICH_SYSTEM_PROMPT).then(res=>{
        removeTyping()
        if(res){ conv.messages.push({from:'in', text:res, ai:true}); save(); renderMessages(conv) }
        else { conv.messages.push({from:'in', text:'Boa pergunta! Posso ajudar com recomenda√ß√µes por estado e relat√≥rios de impacto. Tente: "Recomende ONGs em SP para alimentos" ou "Mostre impacto de RJ".', ai:true}); save(); renderMessages(conv) }
      })
    }

    // ---------- UI handlers ----------
    sendBtn.onclick = ()=>{
      const txt = msgInput.value.trim()
      if(!txt) return
      const conv = convs.find(c=>c.id===activeId)
      conv.messages.push({from:'out', text:txt})
      save(); renderMessages(conv); msgInput.value=''
      showTyping()
      setTimeout(()=> processWithIA(txt), 250)
    }

    limparBtn.onclick = ()=>{
      const conv = convs.find(c=>c.id===activeId)
      if(!conv) return
      if(!confirm('Tem certeza que deseja limpar esta conversa?')) return
      conv.messages = [{from:'in', ai:true, text:'Ol√°! ü§ñ Eu sou a ConectaIA ‚Äî Posso recomendar ONGs por estado e gerar relat√≥rios de impacto. Experimente: \"Recomende ONGs em SP para alimentos\"'}]
      save(); renderMessages(conv)
    }

    // send on Enter
    msgInput.addEventListener('keydown', function(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click() } })

    // expose debug
    window.__convs = convs

    // init
    renderConvs(); openChat(activeId)

  </script>
</body>
</html>